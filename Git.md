# Git

## Зачем

Мы храним в git-репо наши инструменты: проекты Ansible, Terraform, и даже эту документацию.  
Git дает нам  следующие возможности:  

* **Версионность изменений**  
    Позволяет нам вносить правки осмысленными частями(коммитами).  
    Вся история коммитов всегда доступна для просмотра и поиска.  
* **Обратимость изменений**  
    Мы всегда можем откатить до определенного коммита как весь репозиторий, так и только несколько файлов.  
    Работает поиск по изменениям, и мы всегда можем найти коммит, в котором были внесены те или иные изменения.  
* **Независимость изменений**  
    До момент слияния нашей ветки с другой веткой мы не испытываем никакого влияния изменений из других веток.
* **CI**  
    Мы можем прогонять автоматизированные действия как на каждый коммит, так и при определенных условиях.  
    Это позволяет реализовать различные автотесты и автовыкладки.  
* **Ревью изменений**  
    Позволяет нам удобно проводить коллективную оценку изменений перед их слиянием с другими ветками.

## Как

## Инструменты и примеры

### Схлопнуть несколько локальных коммитов в один

Закончили тестирование в отдельной ветке, и хотим подчистить дублирующие коммиты.

* Бэкапим в отдельный бранч на всякий случай `git branch my_backup_branch`
* Вызываем `git log`, считаем глубину до нижнего коммита, который мы хотим сжать.  
    **Внимательно** проверяем, что на этой глубине **нет merge-коммитов**.  
    Если они есть, то схлопнуть этим коммиты **не получится**.  
    _Можно ограничить глубину вывода истории: `git log -10`_  
* Делаем `git rebase -i HEAD~N`, где N - кол-во коммитов на сжатие  
* Откроется редактор  с редактированием списка коммитов  
    _Редактор может быть разным, зависит от переменной окружений EDITOR._  
    _Точно нормально работает с Vim/nano/emacs/mcedit._  
    * верхний коммит трогать нельзя  
    * для "лишних" коммитов заменяем pick на s  
    * сохраняемся, выходим  
* Откроется редактор сообщения коммита, используем творческую силу, сохраняем, выходим  
* Повторно вызываеем `git log`, проверяй, что теперь все выглядит правильно  
* **Внимательно** проверяем ветку, на которой находимся:
    это должна быть исходная ветка, и ни в коем случае **НЕ МАСТЕР**.  
    Убедитесь, что вы работаете над этой веткой один, иначе вы можете затереть коммиты ваших коллег.
* `git push`  
    Он должен выдать ошибку о расхождении данных в локальном и удаленном репо.  
* `git push --force`
    После проверяем в веб-версии, что все изменилось так, как мы и хотели  

### Найти правки в строках N1-N2 файле X

Знаем, что в строках 6-8 файла README были правки, которые нам все сломали.  
Ищем коммиты, которые меняли эти строки:  

```bash
git blame -L 6,8 README.md
^756c345 (Sergei Mikhailov 2019-11-07 19:00:13 +0300 6)
e0b9f53a (Sergei Mikhailov 2019-11-08 12:07:32 +0300 7) ## Ручной запуск тестов
e0b9f53a (Sergei Mikhailov 2019-11-08 12:07:32 +0300 8)
```

Смотрим информацию по последнему коммиту:  

```bash
git show e0b9f53a README.md
commit e0b9f53a7e461053f7bf099231bf6a35dfbc1c1b (HEAD -> feature/common-pain, origin/feature/common-pain)
Author: Sergei Mikhailov <s.mikhaylov@rtk-dc.ru>
Date:   Fri Nov 8 12:07:32 2019 +0300

    Basic lint

diff --git a/README.md b/README.md
index a89f606..cc1bcc5 100644
--- a/README.md
+++ b/README.md
@@ -1,6 +1,12 @@
 # StyleConvention

-В этом репо живут наши соглашения о работе с различными инструментами.
+В этом репо живут наши соглашения о работе с различными инструментами.
 Правки применяются только через Merge Request с апрувом(посредством емодзи) от большинства сотрудников.
 За корректностью разметки и текстов приглядыют автотесты.

+## Ручной запуск тестов
+
+### markdownlint
+
+`docker run -it -v "$PWD:/code" pipelinecomponents/markdownlint:5d96213 mdl -s md.rb -w .`
```

### Откатить файл X на коммит Y

В рамках задачи MYTEAM-19 обнаружили, что коммит *e0b9f53a* ломает наш любимый README.md.  
Создаем отдельную ветку:

```bash
git branch bugfix/MYTEAM-19
git push --set-upstream origin bugfix/MYTEAM-19
```

Откатываем файл README.md на один коммит ранее *e0b9f53a*:

```bash
git reset e0b9f53a~1 README.md
Unstaged changes after reset:
M       README.md
```

Закидываем эти правки:

```bash
git commit -m 'MYTEAM-19 Revert to e0b9f53a~1 due to broken func'
git push
```

### Подтянуть себе правки из мастера и порешать конфликты
