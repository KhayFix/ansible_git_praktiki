# Ansible

## Intro

### Что такое Ansible

> **Ansible** — система управления конфигурациями, написанная на Python, с использованием  
декларативного языка разметки для описания конфигураций. Используется для автоматизации  
настройки и развертывания программного обеспечения.
>>(c) Wikipedia

Главные отличия от Chef, Pupppet и прочих систем конфигурации:

* **Не** клиент-серверная архитектура (для конфигурации целевого хоста не нужен агент).
* Чистый Python под капотом (для конфигурации целевого хоста достаточно иметь там Python).
* Оперирует только состояниями системы (обеспечивает идемпотентность для большинства изменений).
* Большая библиотека модулей в базовой поставке.
* Простота написания новых модулей/фильтров/плагинов.
* YAML в качестве языка разметки.

Кроме того, с некоторыми оговорками умеет в управление Windows-системами.

### Структура

  Описание изменений опирается на таски (task), каждая из которых представляют собой модуль  
(module) с именем (name), в который передаются необходимые для выполнения модуля параметры.
Кроме параметров самого модуля таск может содержать дополнительные параметры, необходимые  
для выполнения самого таска и/или вызова каких-либо действий (например декларация условий  
через **when:** или вызов хэндлеров (handler) через **notify:**).

  Логически связанные серии тасков и необходимые для их выполнения сущности (переменные,  
файлы, шаблоны) группируются в роли (role). Преполагается, что роль должна быть идемпотентной
и независимой (многократный запуск роли не меняет состояния системы и для выполнения роли не нужны  
никакие внешние зависимости).

  Логически связанная последовательность ролей и дополнительные сущности (переменные более высокого  
уровня, inventiry, лимиты) называется плэйбук (playbook). Предполагается, что плэйбук содержит в себе  
только настройки, высокоуровневые переменные и последовательность запуска ролей (с минимальной  
динамической логикой запуска).

### Установка окружения

* Устанавливаем [pyenv](https://github.com/pyenv/pyenv-installer)
* Устанавливаем нужные версии Python:

```bash
    pyenv install 2.7.16
    pyenv install 3.7.4
```

* Создаём venv с нужной версией:

```bash
    pyenv virtualenv 3.7.4 ansible_2.8.4
    pyenv local ansible_2.8.4
```

* Устанавливаем нужные пакеты:

```bash
    pip install requirments.txt
```

Чего **НЕ** стоит делать, если не хочется потом долго дебажить откуда подтянулся модуль старой версии  
и сломал выполнение роли или плэйбука:

* Использовать системный Python и его модули.
* Использовать Python2 (кроме случаев, когда он нужен из-за legacy-кода).
* Устанавливать в окружение пакеты с автоматическим разрешением зависимостей
  (``pip install ansible==2.8.4`` вместо ``pip install requirments.txt``).
* Использовать зависимости, которые ставятся **НЕ** через pip.
  (_кроме редких случаев, когда они дейстивтельно необходимы, но только при согласовании с командой и  
  с детальной документацией_).

## Практики

хуяктики, расскажу, как не ссать на лицо самому себе и коллегам

### Именование

именуй нормально, пидор

### Переменные

* объявляй все необходимые для роли переменные в корень_роли/defaults/main.yml
* не используй корень_роли/vars/*

### Таски

* main.yml - только носителей инклудов\импортов, или ты пидор
* `ansible_distribution_lower_ver: "{{ (ansible_distribution | lower) }}_{{ ansible_distribution_major_version }}"` - для инклудов
* шелл - почти нельзя.  
    и комманд - тоже
* таски должны уметь в чек-мод
* если ты сэтишь факты в тасках, то скорее всего где-то обосрался
* не завязывайся на то, что приедет после setup других хостов: с лимитом ты обосрешься
* `mode:  u=x,g=x,o=x` - пиздец. юзать полный цифровой вид, `mode: 0755`
* бесполезное повсеместное указание owner и group  
    Если твой плэйбук выполняется с become: true, а он должен выполнятся именно так, то явное указание root как владельца избыточно.  
    Аналогично с группой.  
* усы и пробелы
    Между "усами" и значениями внутри них должны быть пробелы.  
    Плохо: `var: "{{key}}"`  
    Нормально: `var: "{{ key }}"`  
* `become: true`  
    Исподьзовать только в случае, когда действительно не нужно повышение привелегий.  
    По дефолту на уровне плэйбука ставить `become: true`, и по необходимости отключать в конкретных тасках.  
* `when: "snmp_exporter is defined"`  
    Определять переменные в дефолтах роли, и избегать when в тасках.

### Хэндлеры

* без шелла, если ты не мудак
* юзай листен, если на разных системых нужно по-разному
* `notify: Systemctl daemon reload`  
    Не забывай при изменении конфигов systemd

### Шаблоны и файлы

* имя файла или шаблона  
    Логично будет назвать шаблон так, чтобы по его имени было понятно, какую функцию он выполняет, и\или где он будет после шаблонизации.  
    Хуево: `src: template.j2`  
    Допустимо:  

```yaml
    src: snmp_exporter.service.j2
    src: etc/systemd/system/snmp_exporter.service.j2
```

hui_data_struct| to_nice_yaml() /thread

### Мета

Или как пойти нахуй с бесполезными файлами

### Доп. плагины

Почему только на python, и как писать, чтоб оно не ебло мозг

### Роли

Что должны покрывать роли и как их понять, сколько пихать в одну роль

### Плэйбуки

Что и как должен делать плэйбук, и почему это не просто запускатор ролей

### Vault

или почему я твою мамку голой видел

## CI/CD

на месте, пидор

### Автотесты

* общие линтеры
* линтеры на каждую роль
* юниты и инты на роль

### Автодеплой

* интеграционные на тестовые площадки
* дифф на прод
* реальный на прод
* ОТКАТЫВАЙ, ОТКАТЫВАЙ

## Антипаттеры

у нас за такое убивают нахуй

### инлайн циклы и if в теле переменной

чуть-чуть можно, а потом тобi пiзда

### копипаста ролей их внешних источников

тобi пiзда  
и за ansible-galaxy - тоже

### отключение тестов

тобi пiзда прямо сразу

### длинные строки

тобi пiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiзда

### привязка ко второму пайтону

коротковат питон
