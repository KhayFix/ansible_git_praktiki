# Ansible

## Intro

### что это и зачем
бла-бла-бла, ансибл заебись и нам нужен  
как с гитом работать я уже показал, теперь про ансибль

### из чего состоит
из твоей мамки, но слегка подрезанной, чтоб влезло в репо

### Установка окружения
* лол-кек-чебурек, pyenv + pip install requirments.txt
* глобальный python - нет
* второй пайтон не\_для\_легаси - нет
* неявные зависимости python, которых нет в requirments.txt - НЕТ
* зависимости, которые не поставить через pip - нет   
    _Кроме очень редких случаев, по согласованию, с детальной докой_

## Практики
хуяктики, расскажу, как не ссать на лицо самому себе и коллегам

### Именование
именуй нормально, пидор

### Переменные
* объявляй все необходимые для роли переменные в корень_роли/defaults/main.yml
* не используй корень_роли/vars/*

### Таски
* main.yml - только носителей инклудов\импортов, или ты пидор
* `ansible_distribution_lower_ver: "{{ (ansible_distribution | lower) }}_{{ ansible_distribution_major_version }}"` - для инклудов
* шелл - почти нельзя.  
    и комманд - тоже
* таски должны уметь в чек-мод
* если ты сэтишь факты в тасках, то скорее всего где-то обосрался
* не завязывайся на то, что приедет после setup других хостов: с лимитом ты обосрешься
* `mode:  u=x,g=x,o=x` - пиздец. юзать полный цифровой вид, `mode: 0755`
* бесполезное повсеместное указание owner и group  
    Если твой плэйбук выполняется с become: true, а он должен выполнятся именно так, то явное указание root как владельца избыточно.  
    Аналогично с группой.  
* усы и пробелы
    Между "усами" и значениями внутри них должны быть пробелы.  
    Плохо: `var: "{{key}}"`  
    Нормально: `var: "{{ key }}"`  
* `become: true`  
    Исподьзовать только в случае, когда действительно не нужно повышение привелегий.  
    По дефолту на уровне плэйбука ставить `become: true`, и по необходимости отключать в конкретных тасках.  
*  `when: "snmp_exporter is defined"`  
    Определять переменные в дефолтах роли, и избегать when в тасках.

### Хэндлеры
* без шелла, если ты не мудак
* юзай листен, если на разных системых нужно по-разному
* `notify: Systemctl daemon reload`  
    Не забывай при изменении конфигов systemd


### Шаблоны и файлы
* имя файла или шаблона  
    Логично будет назвать шаблон так, чтобы по его имени было понятно, какую функцию он выполняет, и\или где он будет после шаблонизации.  
    Хуево: `src: template.j2`  
    Допустимо:  
    ```
    src: snmp_exporter.service.j2
    src: etc/systemd/system/snmp_exporter.service.j2
    ```

hui_data_struct| to_nice_yaml() /thread

### Мета
Или как пойти нахуй с бесполезными файлами

### Доп. плагины
Почему только на python, и как писать, чтоб оно не ебло мозг

### Роли
Что должны покрывать роли и как их понять, сколько пихать в одну роль

### Плэйбуки
Что и как должен делать плэйбук, и почему это не просто запускатор ролей

### Vault
или почему я твою мамку голой видел

## CI/CD
на месте, пидор

### Автотесты
* общие линтеры
* линтеры на каждую роль
* юниты и инты на роль

### Автодеплой
* интеграционные на тестовые площадки
* дифф на прод
* реальный на прод
* ОТКАТЫВАЙ, ОТКАТЫВАЙ

## Антипаттеры
у нас за такое убивают нахуй

### инлайн циклы и if в теле переменной
чуть-чуть можно, а потом тобi пiзда

### копипаста ролей их внешних источников
тобi пiзда  
и за ansible-galaxy - тоже

### отключение тестов
тобi пiзда прямо сразу

### длинные строки
тобi пiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiзда

### привязка ко второму пайтону
коротковат питон
